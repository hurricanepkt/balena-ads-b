name: Sync Fork and Deploy

on:
  schedule:
    - cron: '0 4 * * 0' # every Sunday at 4 AM UTC
  workflow_dispatch: # on button click

jobs:
  merge:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Merge upstream
        id: merge
        run: |
          git config --global user.name 'Mark Greenway'
          git config --global user.email 'hurricanepkt@users.noreply.github.com'

          git remote add upstream https://github.com/ketilmo/balena-ads-b
          git fetch upstream

          BEFORE=$(git rev-parse HEAD)
          git merge --no-edit upstream/master
          AFTER=$(git rev-parse HEAD)

          if [ "$BEFORE" != "$AFTER" ]; then
            echo "changes=true" >> "$GITHUB_OUTPUT"
            echo "upstream_sha=$(git rev-parse --short upstream/master)" >> "$GITHUB_OUTPUT"
            git push origin master
          else
            echo "changes=false" >> "$GITHUB_OUTPUT"
            echo "Already up to date, nothing to push."
          fi

      - name: Trigger Balena deploy
        if: steps.merge.outputs.changes == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh workflow run "Deploy to Balena" \
            --ref master \
            -f upstream_sha=${{ steps.merge.outputs.upstream_sha }}
